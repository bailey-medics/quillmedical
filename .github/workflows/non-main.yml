name: Non-main branch workflows

on:
  push:
    branches-ignore: [main, master]
  pull_request:
    branches-ignore: [main, master]

permissions:
  contents: write

concurrency:
  group: nonmain-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ---------- Python ----------
  python_checks:
    runs-on: ubuntu-latest
    name: Python ${{ matrix.task }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        task: [styling, unit]
        python: ['3.13']

    env:
      PRE_COMMIT_HOME: ${{ github.workspace }}/.pre-commit-cache
      PIP_CACHE_DIR:   ${{ github.workspace }}/.pip-cache
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      # ---- caches (pick per task) ----
      - name: Cache pre-commit & venv (styling)
        if: matrix.task == 'styling'
        uses: actions/cache@v4
        with:
          path: |
            .venv
            ${{ env.PRE_COMMIT_HOME }}
            ${{ env.PIP_CACHE_DIR }}
          key: pc-styling-${{ runner.os }}-py${{ matrix.python }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pc-styling-${{ runner.os }}-py${{ matrix.python }}-
            pc-styling-${{ runner.os }}-

      # ---- styling steps ----
      - name: Ensure venv + pre-commit (styling)
        if: matrix.task == 'styling'
        run: |
          if [ ! -x .venv/bin/python ]; then
            echo "Creating new virtual environment..."
            rm -rf .venv  # Remove corrupted cache
            python -m venv .venv
          else
            echo "Using cached .venv"
          fi
          # Always ensure pre-commit is installed (quick if already present)
          .venv/bin/python -m pip install -U pip
          .venv/bin/python -m pip install "pre-commit>=3,<5"

      - name: Warm pre-commit hooks (styling)
        if: matrix.task == 'styling'
        run: |
          . .venv/bin/activate
          pre-commit install-hooks

      - name: Run pre-commit (styling)
        if: matrix.task == 'styling'
        run: |
          . .venv/bin/activate
          pre-commit run --all-files --show-diff-on-failure --color=always


      - name: Cache Poetry venv & pip (unit)
        if: matrix.task == 'unit'
        uses: actions/cache@v4
        with:
          path: |
            backend/.venv
            ${{ env.PIP_CACHE_DIR }}
          key: pc-unit-${{ runner.os }}-py${{ matrix.python }}-${{ hashFiles('backend/poetry.lock') }}
          restore-keys: |
            pc-unit-${{ runner.os }}-py${{ matrix.python }}-
            pc-unit-${{ runner.os }}-


      - name: Install Poetry (unit)
        if: matrix.task == 'unit'
        run: |
          python -m pip install -U pip poetry
          # in-project venv to make caching deterministic
          poetry config virtualenvs.in-project true


      - name: Install backend deps (unit)
        if: matrix.task == 'unit'
        working-directory: backend
        run: |
          poetry install --with dev --no-interaction --no-ansi


      - name: Pytest (unit)
        if: matrix.task == 'unit'
        working-directory: backend
        run: |
          poetry run pytest -q -m "not integration and not e2e" --maxfail=1 --disable-warnings

  # ---------- JS: run multiple tools in parallel via matrix ----------
  typescript_checks:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: true
      matrix:
        task: [eslint, prettier, stylelint, typecheck, "unit-test:run", "storybook:build", "storybook:test:ci"]
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Enable Corepack & pin Yarn
        run: |
          corepack enable
          corepack prepare yarn@4.10.3 --activate
          yarn --version

      - name: Cache Yarn
        uses: actions/cache@v4
        with:
          path: |
            frontend/.yarn/cache
            frontend/.yarn/install-state.gz
            frontend/node_modules
          key: ${{ runner.os }}-yarn4-nm-${{ hashFiles('frontend/yarn.lock', 'frontend/.yarnrc.yml') }}
          restore-keys: |
            ${{ runner.os }}-yarn4-nm-

      - name: Install deps
        working-directory: frontend
        run: yarn install --immutable

      - name: Install Playwright browsers (for storybook tests)
        if: matrix.task == 'storybook:test:ci'
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Run ${{ matrix.task }}
        working-directory: frontend
        run: |
          case "${{ matrix.task }}" in
            eslint)   yarn eslint ;;
            prettier) yarn prettier ;;
            stylelint) yarn stylelint ;;
            typecheck) yarn typecheck ;;
            "typecheck:all") yarn typecheck:all ;;
            "unit-test:run") yarn unit-test:run ;;
            "storybook:build") yarn storybook:build ;;
            "storybook:test:ci") yarn storybook:test:ci ;;
          esac

  # ---------- Frontend security (Semgrep) ----------
  frontend_security:
    runs-on: ubuntu-latest
    name: Semgrep (frontend SAST)
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # Install Semgrep via pipx (fast, isolated)
      - name: Install Semgrep
        run: pipx install semgrep

      - name: Run Semgrep
        working-directory: frontend
        env:
          SEMGREP_LOG_LEVEL: error
          SEMGREP_DISABLE_ANALYTICS: "1"
          SEMGREP_NO_VERSION_CHECK: "1"
        run: semgrep --config .semgrep.yml --error


  # ---------- Merge to main (only on push, never from main) ----------
  merge-to-main:
    runs-on: ubuntu-latest
    name: Merge branch into main
    needs: [python_checks, typescript_checks, frontend_security]
    if: github.event_name == 'push' && github.ref != 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Merge branch into main and push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Ensure we have latest main locally
          git fetch origin main:main || git fetch origin refs/heads/main:main

          # Source branch name from the push event
          BRANCH_NAME="${GITHUB_REF_NAME:-}"
          BRANCH_NAME=$(echo "$BRANCH_NAME" | tr -d '[:space:]')

          if [ -z "$BRANCH_NAME" ]; then
            echo "ERROR: Cannot determine source branch." >&2
            exit 1
          fi

          if [ "$BRANCH_NAME" = "main" ]; then
            echo "Not merging main into main. Exiting."
            exit 0
          fi

          echo "Merging '$BRANCH_NAME' into main"
          git checkout main

          # Ensure the source branch exists locally
          if ! git rev-parse --verify --quiet "$BRANCH_NAME"; then
            echo "Fetching branch '$BRANCH_NAME' from origin"
            git fetch origin "$BRANCH_NAME":"$BRANCH_NAME"
          fi

          # Attempt merge; on conflict, abort and fail
          if git merge --no-ff "$BRANCH_NAME" -m "Merge branch '$BRANCH_NAME' into main"; then
            echo "Merge succeeded"
          else
            echo "Merge conflict. Aborting."
            git merge --abort || true
            exit 1
          fi

          git push origin main

      - name: Extract commit subject
        id: commit
        run: |
          COMMIT_SUBJECT=$(git log -1 --pretty=%s)
          # Escape for JSON: replace quotes and newlines
          COMMIT_SUBJECT="${COMMIT_SUBJECT//\"/\\\"}"
          COMMIT_SUBJECT="${COMMIT_SUBJECT//$'\n'/ }"
          echo "subject=$COMMIT_SUBJECT" >> $GITHUB_OUTPUT

      - name: Notify Slack on Success
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "✅ Branch `${{ github.ref_name }}` passed all tests and merged to main"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack on Failure
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "❌ Branch `${{ github.ref_name }}` failed to merge to main"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
